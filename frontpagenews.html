<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Newspaper Front Pages</title>
  <meta name="description" content="Front Pages of Newspapers from the Newseum">

	<style>
		#footer{
			position:fixed;
			height:50px;
			background-color:red;
			bottom:0px;
			left:0px;
			right:0px;
			margin-bottom:0px;
			font-size: xx-large;
			font-family: Verdana, Geneva, sans-serif;
			text-align:center;
			padding-top:12px;
		}

		body{
			margin-bottom:50px;
			scroll-behavior: smooth;
		}
	</style>

  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
</head>

<body>
	<script src="./load-image.all.min.js"></script>

	<div id="frontpage_image" style="text-align:center"></div>
	<div id="footer"></div>

	<script>

		// Get region (if present)
		// Possible choices: USA, international, North%20America, Africa, Europe, South%20America, Oceania, Asia, Middle%20East, Caribbean
	
		var QueryString = function () {
		  // This function is anonymous, is executed immediately and 
		  // the return value is assigned to QueryString!
		  var query_string = {};
		  var query = window.location.search.substring(1);
		  var vars = query.split("&");
		  for (var i=0;i<vars.length;i++) {
			var pair = vars[i].split("=");
				// If first entry with this name
			if (typeof query_string[pair[0]] === "undefined") {
			  query_string[pair[0]] = decodeURIComponent(pair[1]);
				// If second entry with this name
			} else if (typeof query_string[pair[0]] === "string") {
			  var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
			  query_string[pair[0]] = arr;
				// If third or later entry with this name
			} else {
			  query_string[pair[0]].push(decodeURIComponent(pair[1]));
			}
		  } 
		  return query_string;
		}();


		var tfp_query = "";
		if (typeof QueryString.region != 'undefined') {
			tfp_query = "tfp_region=" + encodeURI(QueryString.region);
			tfp_query = tfp_query.replace("%", "%25");
		}

		// Load paper links from YQL query
		var s = document.createElement("script");
		s.type = "text/javascript";
		
		s.src = "http://query.yahooapis.com/v1/public/yql?q=select%2A%20from%20htmlstring%20where%20url%3D%22http%3A%2F%2Fwww.newseum.org%2Ftodaysfrontpages%2F%3F" + tfp_query + "%26tfp_show%3Dall%22%20%20and%20xpath%3D%22%2F%2Fdiv%5Bcontains(%40class%2C'thumbnail-group-item')%5D%22&format=json&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=cbfunc";
		document.head.appendChild(s);

		// Settings

		var page_delay = 30000; // default
		if (typeof QueryString.pagedelay != 'undefined') {
			page_delay = parseInt(QueryString.pagedelay)*1000;
		}
		page_delay = Math.max(page_delay, 2000);
		
		var index = 0;
		var scrollInterval;
		var scrollPosition = 0;
		var scrollSteps = 2000.0;
		var topPageTime = 2000;
		var bottomPageTime = 1000;
		var frontpages = [];
	
	
		function cbfunc(data) {
			console.log(data);
			
			var fragment = document.createRange().createContextualFragment(data.query.results.result);
			var thumbnails = fragment.querySelectorAll("div.thumbnail-group-item");
			for (var i=1; i<thumbnails.length; i++) {
				//var url = data.query.results.div[i].p.a.img;
				var frontpage = {
					url: thumbnails[i].querySelector("p a img").getAttribute("src").replace("/med/","/lg/"),
					title: thumbnails[i].querySelector("h4 a").getAttribute("title"),
					location: thumbnails[i].querySelector("div.thumbnail-group-body p").getAttribute("title")
				}
				frontpages.push(frontpage);
			}
			console.log(frontpages);
			loop();
			setInterval(loop, page_delay);
		}
	
	
	
	function loop() {
		
		// Stop scrolling for new image
		if (typeof scrollInterval != 'undefined') {
			clearInterval(scrollInterval);	
		}
		
		document.getElementById('frontpage_image').innerHTML="";
		//unfade(document.getElementById('frontpage_image'));
		window.scrollTo(0,0);
		
		var imageHeight = 0;
		
		loadImage(
			frontpages[index].url,
			function (img) {
				document.getElementById('frontpage_image').appendChild(img);
				imageHeight = img.height;
				},
				{maxWidth: 1024, cover:true} // Options
			);
			
			document.getElementById("footer").innerHTML = frontpages[index].title + "&nbsp;-&nbsp;" + frontpages[index].location;
			unfade(document.getElementById('frontpage_image'));
			//document.getElementById('frontpage_image').style.opacity=1;
			//document.getElementById('frontpage_image').style.display = 'block';
			window.scrollTo(0,0);
			
			scrollPosition = 0;
			
			setTimeout(function() {			
				scrollInterval = setInterval(function() {
					scrollPosition += (imageHeight-window.innerHeight)/scrollSteps;
					window.scrollTo(0,scrollPosition);
					},
					(page_delay - topPageTime - bottomPageTime) / scrollSteps
				);
			}, topPageTime);
			
			
			// Set fade timeout
			setTimeout(function () { 
				fade(document.getElementById('frontpage_image'));
				}, (page_delay-500)
			);
			
			
			index = (index+1) % frontpages.length;
			
	};	
	
	

	function fade(element) {
		var op = 1;  // initial opacity
		var timer = setInterval(function () {
			if (op <= 0.1){
				clearInterval(timer);
				element.style.display = 'none';
			}
			element.style.opacity = op;
			element.style.filter = 'alpha(opacity=' + op * 100 + ")";
			op -= op * 0.1;
    }, 15);
	}
	
	
	
	
	function unfade(element) {
		var op = 0.1;  // initial opacity
		element.style.display = 'block';
		var timer = setInterval(function () {
			if (op >= 1){
				clearInterval(timer);
			}
			element.style.opacity = op;
			element.style.filter = 'alpha(opacity=' + op * 100 + ")";
			op += op * 0.1;
		}, 20);
	}




	</script>
	<!--<script src="https://query.yahooapis.com/v1/public/yql/aruetheswat/Newseum2?format=json&callback=cbfunc"></script>-->
</body>
</html>